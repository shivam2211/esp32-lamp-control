<!DOCTYPE html>
<html lang="en" class="dark">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Floor Lamp Control</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            frame: '#0a0a0a',
            glow: '#fbbf24',
            'glow-dim': '#fcd34d',
          },
          fontFamily: {
            display: ['DM Sans', 'system-ui', 'sans-serif'],
          },
          boxShadow: {
            'glow': '0 0 20px rgba(251, 191, 36, 0.4)',
            'glow-strong': '0 0 30px rgba(251, 191, 36, 0.6)',
          },
        },
      },
    }
  </script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,400;0,9..40,500;0,9..40,600;0,9..40,700&display=swap" rel="stylesheet">
  <style>
    .bulb-on { box-shadow: 0 0 20px rgba(251, 191, 36, 0.5); }
    .bulb-off { filter: grayscale(0.8); opacity: 0.5; }
    .toggle-track { transition: background 0.3s ease; }
    .toggle-thumb { transition: transform 0.3s ease; }
  </style>
</head>
<body class="bg-frame min-h-screen font-display antialiased text-slate-100">
  <div class="max-w-md mx-auto px-6 py-10">
    <!-- Header -->
    <header class="text-center mb-10">
      <div class="inline-flex items-center justify-center w-16 h-16 rounded-2xl bg-slate-800/80 border border-slate-700/50 mb-4">
        <svg class="w-8 h-8 text-amber-400" fill="currentColor" viewBox="0 0 24 24">
          <path d="M9 21c0 .5.4 1 1 1h4c.6 0 1-.5 1-1v-1H9v1zm3-19C8.1 2 5 5.1 5 9c0 2.4 1.2 4.5 3 5.7V17c0 .5.4 1 1 1h6c.6 0 1-.5 1-1v-2.3c1.8-1.3 3-3.4 3-5.7 0-3.9-3.1-7-7-7z"/>
        </svg>
      </div>
      <h1 class="text-2xl font-semibold tracking-tight text-white">Floor Lamp</h1>
      <p class="text-slate-500 text-sm mt-1">Control all 5 bulbs</p>
    </header>

    <!-- ESP32 API Host -->
    <div class="mb-6 rounded-xl bg-slate-900/90 border border-slate-700/50 p-3">
      <label for="api-host" class="block text-xs text-slate-400 mb-2">ESP32 API Host</label>
      <div class="flex gap-2">
        <input id="api-host" type="text" value="192.168.1.11" placeholder="192.168.1.11" class="flex-1 bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 text-sm text-slate-100 placeholder:text-slate-500 focus:outline-none focus:ring-1 focus:ring-amber-400/60">
        <button id="save-host" type="button" class="px-3 py-2 rounded-lg text-sm font-medium bg-slate-700 text-slate-200 hover:bg-slate-600">Save</button>
      </div>
      <p id="host-hint" class="text-[11px] text-slate-500 mt-2">Used for all API calls from GitHub Pages.</p>
    </div>

    <!-- Bulb Controls -->
    <div class="space-y-3">
      <template id="bulb-template">
        <div class="bulb-card bg-slate-900/90 rounded-xl border border-slate-700/50 p-4 flex items-center justify-between gap-4 transition-all duration-300 hover:border-slate-600/50" data-bulb="">
          <div class="flex items-center gap-4 flex-1 min-w-0">
            <div class="bulb-icon w-12 h-12 rounded-full bg-slate-800 flex items-center justify-center flex-shrink-0 transition-all duration-300" data-icon="">
              <svg class="w-6 h-6 text-amber-400/60" fill="currentColor" viewBox="0 0 24 24">
                <path d="M9 21c0 .5.4 1 1 1h4c.6 0 1-.5 1-1v-1H9v1zm3-19C8.1 2 5 5.1 5 9c0 2.4 1.2 4.5 3 5.7V17c0 .5.4 1 1 1h6c.6 0 1-.5 1-1v-2.3c1.8-1.3 3-3.4 3-5.7 0-3.9-3.1-7-7-7z"/>
              </svg>
            </div>
            <span class="font-medium text-slate-200 truncate" data-label="">Bulb 1</span>
          </div>
          <div class="flex items-center gap-2 flex-shrink-0">
            <button type="button" class="toggle-btn px-4 py-2 rounded-lg text-sm font-medium transition-all duration-200" data-action="off">OFF</button>
            <button type="button" class="toggle-btn px-4 py-2 rounded-lg text-sm font-medium transition-all duration-200" data-action="on">ON</button>
          </div>
        </div>
      </template>

      <div id="bulbs-container"></div>
    </div>

    <!-- All On / All Off -->
    <div class="mt-8 flex gap-3">
      <button id="all-on" type="button" class="flex-1 py-3 px-4 rounded-xl bg-amber-500/20 hover:bg-amber-500/30 text-amber-400 font-medium transition-colors border border-amber-500/30">
        All On
      </button>
      <button id="all-off" type="button" class="flex-1 py-3 px-4 rounded-xl bg-slate-800 hover:bg-slate-700 text-slate-400 font-medium transition-colors border border-slate-600/50">
        All Off
      </button>
    </div>

    <!-- Connection status -->
    <div class="mt-8 flex flex-col items-center gap-2">
      <div id="connection-status" class="inline-flex items-center gap-2 px-3 py-1.5 rounded-full bg-slate-800/80 border border-slate-700/50">
        <span id="status-dot" class="w-2 h-2 rounded-full bg-slate-500 animate-pulse"></span>
        <span id="status-text" class="text-slate-500 text-xs">Checking...</span>
      </div>
      <p id="status" class="text-center text-slate-600 text-xs">Ready</p>
    </div>

    <!-- Footer -->
    <p class="text-center text-slate-600 text-xs mt-6">made for Malu ❤</p>
  </div>

  <script>
    const BULB_COUNT = 5;
    const DEFAULT_API_HOST = '192.168.1.11';
    const API_HOST_STORAGE_KEY = 'esp32ApiHost';

    function normalizeBaseUrl(value) {
      let host = (value || '').trim();
      if (!host) host = DEFAULT_API_HOST;
      if (!/^https?:\/\//i.test(host)) host = `http://${host}`;
      return host.replace(/\/+$/, '');
    }

    let baseUrl = normalizeBaseUrl(localStorage.getItem(API_HOST_STORAGE_KEY) || DEFAULT_API_HOST);

    function syncHostInput() {
      const input = document.getElementById('api-host');
      const hint = document.getElementById('host-hint');
      input.value = baseUrl.replace(/^https?:\/\//i, '');
      hint.textContent = `Using: ${baseUrl}`;
    }

    function saveApiHost() {
      const input = document.getElementById('api-host');
      baseUrl = normalizeBaseUrl(input.value);
      localStorage.setItem(API_HOST_STORAGE_KEY, baseUrl);
      syncHostInput();
      checkConnection();
    }

    function getApiUrl(bulb, state) {
      return `${baseUrl}/led${bulb}/${state}`;
    }

    function createBulbCard(index) {
      const template = document.getElementById('bulb-template');
      const clone = template.content.cloneNode(true);
      const card = clone.querySelector('.bulb-card');
      const label = clone.querySelector('[data-label]');
      const icon = clone.querySelector('[data-icon]');

      card.dataset.bulb = index;
      label.textContent = `Bulb ${index}`;

      const offBtn = clone.querySelector('[data-action="off"]');
      const onBtn = clone.querySelector('[data-action="on"]');

      offBtn.classList.add('bg-slate-700', 'text-slate-400', 'hover:bg-slate-600');
      onBtn.classList.add('bg-amber-500/20', 'text-amber-400', 'hover:bg-amber-500/30', 'border', 'border-amber-500/30');

      offBtn.onclick = () => toggleBulb(index, false);
      onBtn.onclick = () => toggleBulb(index, true);

      return clone;
    }

    function setBulbState(card, on) {
      const icon = card.querySelector('[data-icon]');
      const offBtn = card.querySelector('[data-action="off"]');
      const onBtn = card.querySelector('[data-action="on"]');

      if (on) {
        icon.classList.remove('bg-slate-800');
        icon.classList.add('bulb-on', 'bg-amber-500/20', 'border', 'border-amber-500/40');
        icon.querySelector('svg').classList.remove('text-amber-400/60');
        icon.querySelector('svg').classList.add('text-amber-400');
        offBtn.classList.remove('bg-slate-700', 'text-slate-400');
        offBtn.classList.add('bg-slate-800', 'text-slate-500');
        onBtn.classList.remove('bg-amber-500/20', 'border');
        onBtn.classList.add('bg-amber-500', 'text-slate-900', 'border-amber-500');
      } else {
        icon.classList.add('bg-slate-800');
        icon.classList.remove('bulb-on', 'bg-amber-500/20', 'border', 'border-amber-500/40');
        icon.querySelector('svg').classList.add('text-amber-400/60');
        icon.querySelector('svg').classList.remove('text-amber-400');
        offBtn.classList.add('bg-slate-700', 'text-slate-400');
        offBtn.classList.remove('bg-slate-800', 'text-slate-500');
        onBtn.classList.remove('bg-amber-500', 'text-slate-900');
        onBtn.classList.add('bg-amber-500/20', 'text-amber-400', 'border', 'border-amber-500/30');
      }
    }

    async function toggleBulb(bulb, on) {
      const state = on ? 'on' : 'off';
      const statusEl = document.getElementById('status');
      statusEl.textContent = `Bulb ${bulb} ${state}...`;

      try {
        const res = await fetch(getApiUrl(bulb, state));
        if (res.ok) {
          const card = document.querySelector(`[data-bulb="${bulb}"]`);
          if (card) setBulbState(card, on);
          statusEl.textContent = 'Ready';
        } else {
          statusEl.textContent = `Error: ${res.status}`;
        }
      } catch (err) {
        statusEl.textContent = `Error: ${err.message}`;
      }
    }

    async function setAllBulbs(on) {
      const statusEl = document.getElementById('status');
      statusEl.textContent = on ? 'Turning all on...' : 'Turning all off...';

      const promises = [];
      for (let i = 1; i <= BULB_COUNT; i++) {
        promises.push(fetch(getApiUrl(i, on ? 'on' : 'off')));
      }

      try {
        await Promise.all(promises);
        document.querySelectorAll('.bulb-card').forEach((card, i) => {
          setBulbState(card, on);
        });
        statusEl.textContent = 'Ready';
      } catch (err) {
        statusEl.textContent = `Error: ${err.message}`;
      }
    }

    // Init
    const container = document.getElementById('bulbs-container');
    for (let i = 1; i <= BULB_COUNT; i++) {
      container.appendChild(createBulbCard(i));
    }

    document.getElementById('save-host').onclick = saveApiHost;
    document.getElementById('api-host').addEventListener('keydown', (event) => {
      if (event.key === 'Enter') {
        event.preventDefault();
        saveApiHost();
      }
    });
    syncHostInput();

    document.getElementById('all-on').onclick = () => setAllBulbs(true);
    document.getElementById('all-off').onclick = () => setAllBulbs(false);

    // Connection status check
    async function checkConnection() {
      const dot = document.getElementById('status-dot');
      const text = document.getElementById('status-text');
      try {
        const res = await fetch(`${baseUrl}/ping`);
        if (res.ok) {
          dot.classList.remove('bg-slate-500', 'animate-pulse');
          dot.classList.add('bg-emerald-500');
          text.textContent = 'API live • Device ready';
          text.classList.remove('text-slate-500');
          text.classList.add('text-slate-400');
        } else {
          dot.classList.remove('bg-emerald-500');
          dot.classList.add('bg-amber-500', 'animate-pulse');
          text.textContent = 'API error';
          text.classList.add('text-amber-400/80');
        }
      } catch (err) {
        dot.classList.remove('bg-emerald-500');
        dot.classList.add('bg-red-500/80', 'animate-pulse');
        text.textContent = 'Offline';
        text.classList.remove('text-slate-400');
        text.classList.add('text-red-400/80');
      }
    }
    checkConnection();
    setInterval(checkConnection, 10000);
  </script>
</body>
</html>
